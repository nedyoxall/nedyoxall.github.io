<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>A Life in Data - data science</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">A Life in Data </a></h1>
                <nav><ul>
                    <li><a href="/pages/homepage.html">Home</a></li>
                    <li><a href="/category/coding.html">Coding</a></li>
                    <li><a href="/category/data-science.html">Data Science</a></li>
                    <li><a href="/category/random.html">Random</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/entity_resolution_with_dedupe.html">Entity Resolution with Dedupe Package and SQLite</a></h1>
<footer class="post-info">
        <abbr class="published" title="2017-02-01T21:30:00+00:00">
                Published: Wed 01 February 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/ned.html">Ned</a>
        </address>
<p>In <a href="/category/data-science.html">Data Science</a>.</p>
<p>tags: <a href="/tag/data-science.html">data science</a> <a href="/tag/entity-resolution.html">entity resolution</a> </p>
</footer><!-- /.post-info --><style type="text/css">/*!
*
* IPython notebook
*
*/
/* CSS font colors for translated ANSI colors. */
.ansibold {
  font-weight: bold;
}
/* use dark versions for foreground, to improve visibility */
.ansiblack {
  color: black;
}
.ansired {
  color: darkred;
}
.ansigreen {
  color: darkgreen;
}
.ansiyellow {
  color: #c4a000;
}
.ansiblue {
  color: darkblue;
}
.ansipurple {
  color: darkviolet;
}
.ansicyan {
  color: steelblue;
}
.ansigray {
  color: gray;
}
/* and light for background, for the same reason */
.ansibgblack {
  background-color: black;
}
.ansibgred {
  background-color: red;
}
.ansibggreen {
  background-color: green;
}
.ansibgyellow {
  background-color: yellow;
}
.ansibgblue {
  background-color: blue;
}
.ansibgpurple {
  background-color: magenta;
}
.ansibgcyan {
  background-color: cyan;
}
.ansibggray {
  background-color: gray;
}
div.cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  border-radius: 2px;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  border-width: 1px;
  border-style: solid;
  border-color: transparent;
  width: 100%;
  padding: 5px;
  /* This acts as a spacer between cells, that is outside the border */
  margin: 0px;
  outline: none;
  border-left-width: 1px;
  padding-left: 5px;
  background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%);
}
div.cell.jupyter-soft-selected {
  border-left-color: #90CAF9;
  border-left-color: #E3F2FD;
  border-left-width: 1px;
  padding-left: 5px;
  border-right-color: #E3F2FD;
  border-right-width: 1px;
  background: #E3F2FD;
}
@media print {
  div.cell.jupyter-soft-selected {
    border-color: transparent;
  }
}
div.cell.selected {
  border-color: #ababab;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%);
}
@media print {
  div.cell.selected {
    border-color: transparent;
  }
}
div.cell.selected.jupyter-soft-selected {
  border-left-width: 0;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%);
}
.edit_mode div.cell.selected {
  border-color: #66BB6A;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%);
}
@media print {
  .edit_mode div.cell.selected {
    border-color: transparent;
  }
}
.prompt {
  /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */
  min-width: 14ex;
  /* This padding is tuned to match the padding on the CodeMirror editor. */
  padding: 0.4em;
  margin: 0px;
  font-family: monospace;
  text-align: right;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
  /* Don't highlight prompt number selection */
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  /* Use default cursor */
  cursor: default;
}
@media (max-width: 540px) {
  .prompt {
    text-align: left;
  }
}
div.inner_cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
}
@-moz-document url-prefix() {
  div.inner_cell {
    overflow-x: hidden;
  }
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_area {
  border: 1px solid #cfcfcf;
  border-radius: 2px;
  background: #f7f7f7;
  line-height: 1.21429em;
}
/* This is needed so that empty prompt areas can collapse to zero height when there
   is no content in the output_subarea and the prompt. The main purpose of this is
   to make sure that empty JavaScript output_subareas have no height. */
div.prompt:empty {
  padding-top: 0;
  padding-bottom: 0;
}
div.unrecognized_cell {
  padding: 5px 5px 5px 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.unrecognized_cell .inner_cell {
  border-radius: 2px;
  padding: 5px;
  font-weight: bold;
  color: red;
  border: 1px solid #cfcfcf;
  background: #eaeaea;
}
div.unrecognized_cell .inner_cell a {
  color: inherit;
  text-decoration: none;
}
div.unrecognized_cell .inner_cell a:hover {
  color: inherit;
  text-decoration: none;
}
@media (max-width: 540px) {
  div.unrecognized_cell > div.prompt {
    display: none;
  }
}
div.code_cell {
  /* avoid page breaking on code cells when printing */
}
@media print {
  div.code_cell {
    page-break-inside: avoid;
  }
}
/* any special styling for code cells that are currently running goes here */
div.input {
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.input {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_prompt {
  color: #303F9F;
  border-top: 1px solid transparent;
}
div.input_area > div.highlight {
  margin: 0.4em;
  border: none;
  padding: 0px;
  background-color: transparent;
}
div.input_area > div.highlight > pre {
  margin: 0px;
  border: none;
  padding: 0px;
  background-color: transparent;
}
/* The following gets added to the <head> if it is detected that the user has a
 * monospace font with inconsistent normal/bold/italic height.  See
 * notebookmain.js.  Such fonts will have keywords vertically offset with
 * respect to the rest of the text.  The user should select a better font.
 * See: https://github.com/ipython/ipython/issues/1503
 *
 * .CodeMirror span {
 *      vertical-align: bottom;
 * }
 */
.CodeMirror {
  line-height: 1.21429em;
  /* Changed from 1em to our global default */
  font-size: 14px;
  height: auto;
  /* Changed to auto to autogrow */
  background: none;
  /* Changed from white to allow our bg to show through */
}
.CodeMirror-scroll {
  /*  The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/
  /*  We have found that if it is visible, vertical scrollbars appear with font size changes.*/
  overflow-y: hidden;
  overflow-x: auto;
}
.CodeMirror-lines {
  /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */
  /* we have set a different line-height and want this to scale with that. */
  padding: 0.4em;
}
.CodeMirror-linenumber {
  padding: 0 8px 0 4px;
}
.CodeMirror-gutters {
  border-bottom-left-radius: 2px;
  border-top-left-radius: 2px;
}
.CodeMirror pre {
  /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */
  /* .CodeMirror-lines */
  padding: 0;
  border: 0;
  border-radius: 0;
}
/*

Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org>
Adapted from GitHub theme

*/
.highlight-base {
  color: #000;
}
.highlight-variable {
  color: #000;
}
.highlight-variable-2 {
  color: #1a1a1a;
}
.highlight-variable-3 {
  color: #333333;
}
.highlight-string {
  color: #BA2121;
}
.highlight-comment {
  color: #408080;
  font-style: italic;
}
.highlight-number {
  color: #080;
}
.highlight-atom {
  color: #88F;
}
.highlight-keyword {
  color: #008000;
  font-weight: bold;
}
.highlight-builtin {
  color: #008000;
}
.highlight-error {
  color: #f00;
}
.highlight-operator {
  color: #AA22FF;
  font-weight: bold;
}
.highlight-meta {
  color: #AA22FF;
}
/* previously not defined, copying from default codemirror */
.highlight-def {
  color: #00f;
}
.highlight-string-2 {
  color: #f50;
}
.highlight-qualifier {
  color: #555;
}
.highlight-bracket {
  color: #997;
}
.highlight-tag {
  color: #170;
}
.highlight-attribute {
  color: #00c;
}
.highlight-header {
  color: blue;
}
.highlight-quote {
  color: #090;
}
.highlight-link {
  color: #00c;
}
/* apply the same style to codemirror */
.cm-s-ipython span.cm-keyword {
  color: #008000;
  font-weight: bold;
}
.cm-s-ipython span.cm-atom {
  color: #88F;
}
.cm-s-ipython span.cm-number {
  color: #080;
}
.cm-s-ipython span.cm-def {
  color: #00f;
}
.cm-s-ipython span.cm-variable {
  color: #000;
}
.cm-s-ipython span.cm-operator {
  color: #AA22FF;
  font-weight: bold;
}
.cm-s-ipython span.cm-variable-2 {
  color: #1a1a1a;
}
.cm-s-ipython span.cm-variable-3 {
  color: #333333;
}
.cm-s-ipython span.cm-comment {
  color: #408080;
  font-style: italic;
}
.cm-s-ipython span.cm-string {
  color: #BA2121;
}
.cm-s-ipython span.cm-string-2 {
  color: #f50;
}
.cm-s-ipython span.cm-meta {
  color: #AA22FF;
}
.cm-s-ipython span.cm-qualifier {
  color: #555;
}
.cm-s-ipython span.cm-builtin {
  color: #008000;
}
.cm-s-ipython span.cm-bracket {
  color: #997;
}
.cm-s-ipython span.cm-tag {
  color: #170;
}
.cm-s-ipython span.cm-attribute {
  color: #00c;
}
.cm-s-ipython span.cm-header {
  color: blue;
}
.cm-s-ipython span.cm-quote {
  color: #090;
}
.cm-s-ipython span.cm-link {
  color: #00c;
}
.cm-s-ipython span.cm-error {
  color: #f00;
}
.cm-s-ipython span.cm-tab {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=);
  background-position: right;
  background-repeat: no-repeat;
}
div.output_wrapper {
  /* this position must be relative to enable descendents to be absolute within it */
  position: relative;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  z-index: 1;
}
/* class for the output area when it should be height-limited */
div.output_scroll {
  /* ideally, this would be max-height, but FF barfs all over that */
  height: 24em;
  /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */
  width: 100%;
  overflow: auto;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  display: block;
}
/* output div while it is collapsed */
div.output_collapsed {
  margin: 0px;
  padding: 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
div.out_prompt_overlay {
  height: 100%;
  padding: 0px 0.4em;
  position: absolute;
  border-radius: 2px;
}
div.out_prompt_overlay:hover {
  /* use inner shadow to get border that is computed the same on WebKit/FF */
  -webkit-box-shadow: inset 0 0 1px #000;
  box-shadow: inset 0 0 1px #000;
  background: rgba(240, 240, 240, 0.5);
}
div.output_prompt {
  color: #D84315;
}
/* This class is the outer container of all output sections. */
div.output_area {
  padding: 0px;
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.output_area .MathJax_Display {
  text-align: left !important;
}
div.output_area 
div.output_area 
div.output_area img,
div.output_area svg {
  max-width: 100%;
  height: auto;
}
div.output_area img.unconfined,
div.output_area svg.unconfined {
  max-width: none;
}
/* This is needed to protect the pre formating from global settings such
   as that of bootstrap */
.output {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.output_area {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
div.output_area pre {
  margin: 0;
  padding: 0;
  border: 0;
  vertical-align: baseline;
  color: black;
  background-color: transparent;
  border-radius: 0;
}
/* This class is for the output subarea inside the output_area and after
   the prompt div. */
div.output_subarea {
  overflow-x: auto;
  padding: 0.4em;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
  max-width: calc(100% - 14ex);
}
div.output_scroll div.output_subarea {
  overflow-x: visible;
}
/* The rest of the output_* classes are for special styling of the different
   output types */
/* all text output has this class: */
div.output_text {
  text-align: left;
  color: #000;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
}
/* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */
div.output_stderr {
  background: #fdd;
  /* very light red background for stderr */
}
div.output_latex {
  text-align: left;
}
/* Empty output_javascript divs should have no height */
div.output_javascript:empty {
  padding: 0;
}
.js-error {
  color: darkred;
}
/* raw_input styles */
div.raw_input_container {
  line-height: 1.21429em;
  padding-top: 5px;
}
pre.raw_input_prompt {
  /* nothing needed here. */
}
input.raw_input {
  font-family: monospace;
  font-size: inherit;
  color: inherit;
  width: auto;
  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;
  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0em 0.25em;
  margin: 0em 0.25em;
}
input.raw_input:focus {
  box-shadow: none;
}
p.p-space {
  margin-bottom: 10px;
}
div.output_unrecognized {
  padding: 5px;
  font-weight: bold;
  color: red;
}
div.output_unrecognized a {
  color: inherit;
  text-decoration: none;
}
div.output_unrecognized a:hover {
  color: inherit;
  text-decoration: none;
}
.rendered_html {
  color: #000;
  /* any extras will just be numbers: */
}



.rendered_html :link {
  text-decoration: underline;
}
.rendered_html :visited {
  text-decoration: underline;
}






.rendered_html h1:first-child {
  margin-top: 0.538em;
}
.rendered_html h2:first-child {
  margin-top: 0.636em;
}
.rendered_html h3:first-child {
  margin-top: 0.777em;
}
.rendered_html h4:first-child {
  margin-top: 1em;
}
.rendered_html h5:first-child {
  margin-top: 1em;
}
.rendered_html h6:first-child {
  margin-top: 1em;
}








.rendered_html * + ul {
  margin-top: 1em;
}
.rendered_html * + ol {
  margin-top: 1em;
}


.rendered_html pre,



.rendered_html tr,
.rendered_html th,

.rendered_html td,


.rendered_html * + table {
  margin-top: 1em;
}

.rendered_html * + p {
  margin-top: 1em;
}

.rendered_html * + img {
  margin-top: 1em;
}
.rendered_html img,

.rendered_html img.unconfined,

div.text_cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.text_cell > div.prompt {
    display: none;
  }
}
div.text_cell_render {
  /*font-family: "Helvetica Neue", Arial, Helvetica, Geneva, sans-serif;*/
  outline: none;
  resize: none;
  width: inherit;
  border-style: none;
  padding: 0.5em 0.5em 0.5em 0.4em;
  color: #000;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
}
a.anchor-link:link {
  text-decoration: none;
  padding: 0px 20px;
  visibility: hidden;
}
h1:hover .anchor-link,
h2:hover .anchor-link,
h3:hover .anchor-link,
h4:hover .anchor-link,
h5:hover .anchor-link,
h6:hover .anchor-link {
  visibility: visible;
}
.text_cell.rendered .input_area {
  display: none;
}
.text_cell.rendered 
.text_cell.unrendered .text_cell_render {
  display: none;
}
.cm-header-1,
.cm-header-2,
.cm-header-3,
.cm-header-4,
.cm-header-5,
.cm-header-6 {
  font-weight: bold;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
.cm-header-1 {
  font-size: 185.7%;
}
.cm-header-2 {
  font-size: 157.1%;
}
.cm-header-3 {
  font-size: 128.6%;
}
.cm-header-4 {
  font-size: 110%;
}
.cm-header-5 {
  font-size: 100%;
  font-style: italic;
}
.cm-header-6 {
  font-size: 100%;
  font-style: italic;
}
</style>
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
<style type="text/css">
/* Temporary definitions which will become obsolete with Notebook release 5.0 */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="kn">import</span> <span class="nn">dedupe</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">optparse</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">sqlite3</span> <span class="kn">as</span> <span class="nn">lite</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="mi">999</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Original-data-and-cleaning">Original data and cleaning<a class="anchor-link" href="#Original-data-and-cleaning">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/companies-with-controlling-entities v6.csv&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/nedyoxall/anaconda/envs/datakind3/lib/python3.5/site-packages/IPython/core/interactiveshell.py:2717: DtypeWarning: Columns (0) have mixed types. Specify dtype option on import or set low_memory=False.
  interactivity=interactivity, compiler=compiler, result=result)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[3]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>company_number</th>
      <th>company_name</th>
      <th>jurisdiction_code</th>
      <th>Controlling Entity SKey</th>
      <th>Controlling Entity Name</th>
      <th>opencorporates_url</th>
      <th>address_care_of</th>
      <th>address_country</th>
      <th>address_locality</th>
      <th>address_postal_code</th>
      <th>address_region</th>
      <th>address_street</th>
      <th>controlling_company_type</th>
      <th>country_of_residence</th>
      <th>dob_month</th>
      <th>dob_year</th>
      <th>family_name</th>
      <th>given_name</th>
      <th>middle_name</th>
      <th>nationality</th>
      <th>po_box</th>
      <th>title</th>
      <th>uid</th>
      <th>ultimate_entity_company_number</th>
      <th>controlling_entity_company_number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>452</td>
      <td>VERNON INVESTMENTS (1856) LIMITED</td>
      <td>gb</td>
      <td>0</td>
      <td>Mrs Mary Jane Ursula White</td>
      <td>https://opencorporates.com/companies/gb/00000452</td>
      <td>NaN</td>
      <td>United Kingdom</td>
      <td>High Wycombe</td>
      <td>HP10 9QN</td>
      <td>Bucks.</td>
      <td>The Mill House Boundary Road\nLoudwater</td>
      <td>NaN</td>
      <td>United Kingdom</td>
      <td>8.0</td>
      <td>1961.0</td>
      <td>White</td>
      <td>Mary</td>
      <td>Jane Ursula</td>
      <td>British</td>
      <td>NaN</td>
      <td>Mrs</td>
      <td>/company/00000452/persons-with-significant-con...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>452</td>
      <td>VERNON INVESTMENTS (1856) LIMITED</td>
      <td>gb</td>
      <td>1</td>
      <td>Mr Andrew Gwynne Haydon White</td>
      <td>https://opencorporates.com/companies/gb/00000452</td>
      <td>NaN</td>
      <td>United Kingdom</td>
      <td>High Wycombe</td>
      <td>HP10 9QN</td>
      <td>Bucks.</td>
      <td>The Mill House Boundary Road\nLoudwater</td>
      <td>NaN</td>
      <td>United Kingdom</td>
      <td>2.0</td>
      <td>1960.0</td>
      <td>White</td>
      <td>Andrew</td>
      <td>Gwynne Haydon</td>
      <td>British</td>
      <td>NaN</td>
      <td>Mr</td>
      <td>/company/00000452/persons-with-significant-con...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># TODO - trim left and right of name for spaces? </span>
<span class="c1"># TODO - check that the index is unique, or will cause problems at a later date!</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Select just the columns that are useful for entity resolution. Then:</p>
<ol>
<li>Remove rows with nulls in for family name and given name columns.</li>
<li>Fill NaNs in other columns with None (required for dedupe package to work properly on String types).</li>
<li>Convert numbers to strings - maybe the best way of dealing with human input text?? Open question!</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">to_dedupe</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;family_name&#39;</span><span class="p">,</span> <span class="s1">&#39;given_name&#39;</span><span class="p">,</span> <span class="s1">&#39;middle_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dob_year&#39;</span><span class="p">,</span> <span class="s1">&#39;dob_month&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># Some utility functions for getting dataframes ready for deduping</span>
<span class="k">def</span> <span class="nf">remove_nulls_from_these_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Utility function to remove nulls from the specified columns of a dataframe.</span>
<span class="sd">        </span>
<span class="sd">        Inputs: - df -&gt; dataframe to remove nulls from</span>
<span class="sd">                - columns -&gt; list of columns which should have no nulls in</span>
<span class="sd">                </span>
<span class="sd">        Outputs: - new dataframe without nulls</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Number of rows before removing nulls: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)))</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">no_null</span> <span class="o">=</span> <span class="n">to_remove</span><span class="p">[</span><span class="n">to_remove</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Number of rows after removing &quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">no_null</span><span class="p">)))</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="n">no_null</span>
        
    <span class="k">return</span> <span class="n">no_null</span>

<span class="k">def</span> <span class="nf">fill_nulls_with_none</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Fills nulls in a dataframe with None.</span>
<span class="sd">        This is required for the Dedupe package to work properly.</span>
<span class="sd">        </span>
<span class="sd">        Input: - dataframe with nulls as NaN</span>
<span class="sd">        </span>
<span class="sd">        Output: - new dataframe with nulls as None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_df</span>

<span class="k">def</span> <span class="nf">convert_numbers_to_strings</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols_to_convert</span><span class="p">,</span> <span class="n">remove_point_zero</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert number types to strings in a dataframe.</span>
<span class="sd">        This is convoluted as need to keep NoneTypes as NoneTypes for what comes next!</span>
<span class="sd">        </span>
<span class="sd">        Inputs: - df -&gt; dataframe to convert number types</span>
<span class="sd">                - cols_to_convert -&gt; list of columns to convert</span>
<span class="sd">                - remove_point_zero -&gt; bool to say whether you want &#39;.0&#39; removed from number</span>
<span class="sd">        </span>
<span class="sd">        Ouputs: - dataframe with converted number types</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_convert</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">remove_point_zero</span><span class="p">:</span>
            <span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>\
                                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>\
                                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_df</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">to_dedupe</span> <span class="o">=</span> <span class="n">remove_nulls_from_these_columns</span><span class="p">(</span><span class="n">to_dedupe</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;family_name&#39;</span><span class="p">,</span><span class="s1">&#39;given_name&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">to_dedupe</span> <span class="o">=</span> <span class="n">fill_nulls_with_none</span><span class="p">(</span><span class="n">to_dedupe</span><span class="p">)</span>
<span class="n">to_dedupe</span> <span class="o">=</span> <span class="n">convert_numbers_to_strings</span><span class="p">(</span><span class="n">to_dedupe</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dob_year&#39;</span><span class="p">,</span><span class="s1">&#39;dob_month&#39;</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Number of rows before removing nulls: 759447
Number of rows after removing family_name: 706156
Number of rows after removing given_name: 706151
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">to_dedupe</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[8]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>family_name</th>
      <th>given_name</th>
      <th>middle_name</th>
      <th>dob_year</th>
      <th>dob_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>White</td>
      <td>Mary</td>
      <td>Jane Ursula</td>
      <td>1961</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>White</td>
      <td>Andrew</td>
      <td>Gwynne Haydon</td>
      <td>1960</td>
      <td>2</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Cooke</td>
      <td>Bernard</td>
      <td>Patrick</td>
      <td>1939</td>
      <td>3</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Schofield</td>
      <td>Peter</td>
      <td>Malcolm</td>
      <td>1944</td>
      <td>2</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Howells</td>
      <td>Peter</td>
      <td>John</td>
      <td>1951</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Dedupe requires that the input data be in the form of a list of dicts:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">to_dedupe_dict</span> <span class="o">=</span> <span class="n">to_dedupe</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is what the entries of the list look like:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">to_dedupe_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[10]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{&#39;dob_month&#39;: &#39;8&#39;,
 &#39;dob_year&#39;: &#39;1961&#39;,
 &#39;family_name&#39;: &#39;White&#39;,
 &#39;given_name&#39;: &#39;Mary&#39;,
 &#39;middle_name&#39;: &#39;Jane Ursula&#39;}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For convenience while testing, store the <code>to_dedupe_dict</code> object as a pickle file:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;to_dedupe_dict.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">to_dedupe_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;to_dedupe_dict.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">to_dedupe_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setting-up-the-Dedupe-object">Setting up the Dedupe object<a class="anchor-link" href="#Setting-up-the-Dedupe-object">&#182;</a></h2><p>Each field (or, in other words, column) has to be declared and given a type. You can read about the different options <a href="https://dedupe.readthedocs.io/en/latest/Variable-definition.html">here</a>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># docs for this are here: </span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;field&#39;</span> <span class="p">:</span> <span class="s1">&#39;family_name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s1">&#39;String&#39;</span><span class="p">},</span>
          <span class="p">{</span><span class="s1">&#39;field&#39;</span> <span class="p">:</span> <span class="s1">&#39;given_name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;String&#39;</span><span class="p">},</span> 
          <span class="p">{</span><span class="s1">&#39;field&#39;</span> <span class="p">:</span> <span class="s1">&#39;middle_name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="s1">&#39;has_missing&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
          <span class="p">{</span><span class="s1">&#39;field&#39;</span> <span class="p">:</span> <span class="s1">&#39;dob_year&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="s1">&#39;has_missing&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
          <span class="p">{</span><span class="s1">&#39;field&#39;</span> <span class="p">:</span> <span class="s1">&#39;dob_month&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="s1">&#39;has_missing&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}]</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># There is a bug later on that requires num_cores to be 1, but we can make use of</span>
<span class="c1"># multi-threaded processes in the meantime</span>
<span class="n">deduper</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">Dedupe</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We then sample the data to get something to train on. More information about all of the <code>deduper</code> object methods can be found <a href="https://dedupe.readthedocs.io/en/latest/API-documentation.html#dedupe-objects">here</a>. Note that training is done by a human - pairs of records are presented and you're asked whether they are referring to the same thing or not (coming to this bit shortly!)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">deduper</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">to_dedupe_dict</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training-dedupe-with-human-matched-records">Training dedupe with human-matched records<a class="anchor-link" href="#Training-dedupe-with-human-matched-records">&#182;</a></h2><p>If you've already done the training, load the file that contains the record pairs marked as being duplicates or not. (It gets saved as a json file).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">training_file</span> <span class="o">=</span> <span class="s1">&#39;controlling_entities_dedupe_training.json&#39;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">training_file</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;reading labeled examples from &#39;</span><span class="p">,</span> <span class="n">training_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">training_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
        <span class="n">deduper</span><span class="o">.</span><span class="n">readTraining</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;no training file found - will create new one: &#39;</span> <span class="o">+</span> <span class="n">training_file</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:dedupe.api:reading training from file
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>reading labeled examples from  controlling_entities_dedupe_training.json
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">dedupe</span><span class="o">.</span><span class="n">convenience</span><span class="o">.</span><span class="n">consoleLabel</span><span class="p">(</span><span class="n">deduper</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Hilton
given_name : Paul
middle_name : Christopher
dob_year : 1967
dob_month : 6

family_name : Hilton
given_name : Paul
middle_name : None
dob_year : 1967
dob_month : 10

21/10 positive, 27/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Watts
given_name : Stephen
middle_name : Patrick James
dob_year : 1951
dob_month : 3

family_name : Watt
given_name : Stephen
middle_name : None
dob_year : 1959
dob_month : 3

21/10 positive, 28/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Perkins
given_name : Mary
middle_name : Lesley
dob_year : 1943
dob_month : 2

family_name : Perkins
given_name : Mary
middle_name : Lesley
dob_year : 1944
dob_month : 2

21/10 positive, 29/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Brown
given_name : Dominic
middle_name : None
dob_year : 1973
dob_month : 8

family_name : Brownlee
given_name : Dominic
middle_name : None
dob_year : 1978
dob_month : 8

22/10 positive, 29/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Kirby
given_name : Hugo
middle_name : Giles Stephen Astley
dob_year : 1953
dob_month : 5

family_name : Kirby
given_name : Hugo
middle_name : Giles Stephen Astley
dob_year : 1958
dob_month : 5

22/10 positive, 30/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Chen
given_name : Hongbing
middle_name : None
dob_year : 1971
dob_month : 12

family_name : Chen
given_name : Hongbin
middle_name : None
dob_year : 1970
dob_month : 12

23/10 positive, 30/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : White
given_name : June
middle_name : Elizabeth
dob_year : 1949
dob_month : 6

family_name : Whitehouse
given_name : June
middle_name : None
dob_year : 1941
dob_month : 6

24/10 positive, 30/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Greaves
given_name : Justin
middle_name : Piers Leonard
dob_year : 1947
dob_month : 12

family_name : Greaves
given_name : Justin
middle_name : Piers Leonard
dob_year : 1957
dob_month : 12

24/10 positive, 31/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Grant
given_name : Jo
middle_name : None
dob_year : 1970
dob_month : 8

family_name : Grant
given_name : John
middle_name : Kenneth
dob_year : 1960
dob_month : 8

25/10 positive, 31/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Quinn
given_name : Paul
middle_name : Lawrence Patrick
dob_year : 1971
dob_month : 6

family_name : Quinn
given_name : Paul
middle_name : Patrick
dob_year : 1979
dob_month : 6

25/10 positive, 32/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Kirby
given_name : Hugo
middle_name : Giles Stephen Astley
dob_year : 1958
dob_month : 5

family_name : Kirby
given_name : Hugo
middle_name : Giles Stephen Astley
dob_year : 1953
dob_month : 5

25/10 positive, 33/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Meek
given_name : Jeffrey
middle_name : Andrew Callaghan
dob_year : 1963
dob_month : 4

family_name : Meek
given_name : Jeffrey
middle_name : Andrew Callaghan
dob_year : 1962
dob_month : 4

26/10 positive, 33/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Dalton
given_name : Richard
middle_name : Alistair
dob_year : 1969
dob_month : 1

family_name : Dalton
given_name : Richard
middle_name : None
dob_year : 1960
dob_month : 12

27/10 positive, 33/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Harris
given_name : Jarod
middle_name : Thomas Chamberlain
dob_year : 1971
dob_month : 2

family_name : Harris
given_name : Jarod
middle_name : Thomas Chamberlain
dob_year : 1972
dob_month : 2

27/10 positive, 34/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Parsons
given_name : Andrew
middle_name : None
dob_year : 1964
dob_month : 1

family_name : Parsons
given_name : Andrew
middle_name : Keith
dob_year : 1961
dob_month : 11

28/10 positive, 34/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Prabhaker
given_name : Sangeet
middle_name : Alejanro Luis
dob_year : 1979
dob_month : 3

family_name : Prabhaker
given_name : Sangeet
middle_name : Alejanro Luis
dob_year : 1976
dob_month : 3

28/10 positive, 35/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Griffiths
given_name : Peter
middle_name : David
dob_year : 1959
dob_month : 12

family_name : Griffiths
given_name : Peter
middle_name : None
dob_year : 1979
dob_month : 1

29/10 positive, 35/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Davies
given_name : Peter
middle_name : Joseph Mansel
dob_year : 1969
dob_month : 9

family_name : Davies
given_name : Peter
middle_name : Joseph Mansel
dob_year : 1962
dob_month : 9

29/10 positive, 36/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Noble
given_name : David
middle_name : None
dob_year : 1956
dob_month : 1

family_name : Noble
given_name : David
middle_name : Clive
dob_year : 1955
dob_month : 11

30/10 positive, 36/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Beever Estate
given_name : Executors
middle_name : Of Edward
dob_year : 2015
dob_month : 9

family_name : Beever
given_name : The
middle_name : Executors Of Edward
dob_year : 2015
dob_month : 9

30/10 positive, 37/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Jones
given_name : Darren
middle_name : Raymond
dob_year : 1971
dob_month : 5

family_name : Jones
given_name : Darren
middle_name : Paul
dob_year : 1976
dob_month : 5

31/10 positive, 37/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Solanki
given_name : Nimesh
middle_name : None
dob_year : 1980
dob_month : 4

family_name : Solanki
given_name : Kailesh
middle_name : None
dob_year : 1980
dob_month : 4

31/10 positive, 38/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Anstruther Gough Calthorpe Bt
given_name : Euan
middle_name : Hamilton
dob_year : 1966
dob_month : 6

family_name : Anstruther Gough Calthorpe Bt
given_name : Euan
middle_name : Hamilton
dob_year : 1996
dob_month : 6

31/10 positive, 39/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Thomson
given_name : William
middle_name : George Ritchie
dob_year : 1951
dob_month : 5

family_name : Thomson
given_name : William
middle_name : George Ritchie
dob_year : 1950
dob_month : 5

32/10 positive, 39/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Hall
given_name : Richard
middle_name : Bruce
dob_year : 1952
dob_month : 10

family_name : Billingsley
given_name : Richard
middle_name : Albert
dob_year : 1952
dob_month : 10

33/10 positive, 39/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Shiekh
given_name : Amar
middle_name : None
dob_year : 1961
dob_month : 1

family_name : Sheikh
given_name : Amar
middle_name : None
dob_year : 1961
dob_month : 1

33/10 positive, 40/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : De Pellette
given_name : Alan
middle_name : James
dob_year : 1968
dob_month : 12

family_name : De Pellette
given_name : Alan
middle_name : None
dob_year : 1968
dob_month : 2

34/10 positive, 40/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Harris
given_name : Anthony
middle_name : None
dob_year : 1968
dob_month : 10

family_name : Harris
given_name : Anthony
middle_name : John
dob_year : 1968
dob_month : 5

35/10 positive, 40/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Collison
given_name : Christian
middle_name : David Ross
dob_year : 1984
dob_month : 11

family_name : Collison
given_name : Christian
middle_name : David Ross
dob_year : 1984
dob_month : 8

35/10 positive, 41/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Newett
given_name : David
middle_name : Ian
dob_year : 1959
dob_month : 2

family_name : Newett
given_name : David
middle_name : Ian
dob_year : 1959
dob_month : 12

36/10 positive, 41/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Farrugia
given_name : Paul
middle_name : John
dob_year : 1957
dob_month : 11

family_name : Farrugia
given_name : Paula
middle_name : None
dob_year : 1957
dob_month : 2

37/10 positive, 41/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Paterson
given_name : Thomas
middle_name : James
dob_year : 1979
dob_month : 9

family_name : Paterson
given_name : Thomas
middle_name : James
dob_year : 1979
dob_month : 10

37/10 positive, 42/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Chesterfield
given_name : Philip
middle_name : Markham
dob_year : 1965
dob_month : 12

family_name : Chesterfield
given_name : Philip
middle_name : Markham
dob_year : 1965
dob_month : 2

38/10 positive, 42/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Sanders
given_name : Justin
middle_name : David Cavania
dob_year : 1972
dob_month : 6

family_name : Sanders
given_name : Justin
middle_name : David Cavania
dob_year : 1976
dob_month : 6

39/10 positive, 42/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Anstruther Gough Calthorpe Bt
given_name : Euan
middle_name : Hamilton
dob_year : 1996
dob_month : 6

family_name : Anstruther Gough Calthorpe Bt
given_name : Euan
middle_name : Hamilton
dob_year : 1966
dob_month : 6

40/10 positive, 42/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Beattie
given_name : Will
middle_name : Eric Macdonald
dob_year : 1973
dob_month : 3

family_name : Beattie
given_name : William
middle_name : Brian
dob_year : 1943
dob_month : 3

41/10 positive, 42/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>n
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Meath Baker
given_name : Prescilla
middle_name : Ann
dob_year : 1937
dob_month : 5

family_name : Meath Baker
given_name : Prescilla
middle_name : Ann
dob_year : 1938
dob_month : 5

41/10 positive, 43/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>y
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>family_name : Millar
given_name : Lynne
middle_name : Patricia
dob_year : 1959
dob_month : 3

family_name : Wall
given_name : Lynne
middle_name : None
dob_year : 1959
dob_month : 3

42/10 positive, 43/10 negative
Do these records refer to the same thing?
(y)es / (n)o / (u)nsure / (f)inished
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>f
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>Finished labeling
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once you've provided the training data, you can train the model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># learn both the classifier and blocking rules</span>
<span class="c1"># max_comparisons seems to be SUPER important in finding good predicates</span>
<span class="n">deduper</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">recall</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">maximum_comparisons</span><span class="o">=</span><span class="mi">1000000000</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:rlr.crossvalidation:using cross validation to find optimum alpha...
INFO:rlr.crossvalidation:optimum alpha: 0.001000
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, given_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, given_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, given_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, given_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, given_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, given_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, given_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, given_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, given_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, given_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, given_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, given_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, dob_month)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, dob_month)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, dob_month)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, dob_month)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, dob_month)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, dob_month)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, dob_month)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, dob_month)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, dob_month)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, dob_month)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, dob_month)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, dob_month)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, middle_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, middle_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, middle_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, middle_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, middle_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, middle_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, middle_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, middle_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, family_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, family_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, family_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, family_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, family_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, family_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, family_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, family_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, family_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, family_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, family_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, family_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, dob_year)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, dob_year)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, dob_year)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, dob_year)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, dob_year)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, dob_year)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, dob_year)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, dob_year)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, dob_year)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, dob_year)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, dob_year)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, dob_year)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, given_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, given_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, given_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, given_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, given_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, given_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, given_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, given_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, given_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, given_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, given_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, given_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, dob_month)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, dob_month)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, dob_month)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, dob_month)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, dob_month)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, dob_month)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, dob_month)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, dob_month)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, dob_month)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, dob_month)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, dob_month)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, dob_month)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, middle_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, middle_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, middle_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, middle_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, middle_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, middle_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, middle_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, middle_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, family_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, family_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, family_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, family_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, family_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, family_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, family_name)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, family_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, family_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, family_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, family_name)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, family_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, dob_year)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.6, dob_year)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, dob_year)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, dob_year)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (4, dob_year)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (1, dob_year)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (3, dob_year)
INFO:dedupe.blocking:Canopy: LevenshteinCanopyPredicate: (2, dob_year)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.2, dob_year)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.6, dob_year)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.8, dob_year)
INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, dob_year)
INFO:dedupe.training:Final predicate set:
INFO:dedupe.training:(SimplePredicate: (commonThreeTokens, family_name), TfidfTextCanopyPredicate: (0.2, middle_name))
INFO:dedupe.training:(SimplePredicate: (commonSixGram, family_name), SimplePredicate: (commonThreeTokens, middle_name))
INFO:dedupe.training:(SimplePredicate: (commonTwoTokens, family_name), SimplePredicate: (twoGramFingerprint, family_name))
INFO:dedupe.training:(TfidfTextCanopyPredicate: (0.4, family_name), TfidfTextCanopyPredicate: (0.8, middle_name))
INFO:dedupe.training:(SimplePredicate: (fingerprint, family_name), TfidfNGramCanopyPredicate: (0.4, dob_month))
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The blocking rules have now been found, and the classifier has also been trained. The classifier (which determines whether 2 records are the same or not) is an L2 regularized logistic regression. Any model in SK learn with a fit and predict_proba method could be used in its place.</p>
<p>Just to demonstrate the inputs to the model, we select 2 records from the inputs:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">record_pairs</span> <span class="o">=</span> <span class="p">((</span><span class="n">to_dedupe_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">to_dedupe_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]),)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model features are given by:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">deduper</span><span class="o">.</span><span class="n">data_model</span><span class="o">.</span><span class="n">_field_comparators</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[(&#39;family_name&#39;, &lt;built-in function normalizedAffineGapDistance&gt;, 0, 1), (&#39;given_name&#39;, &lt;built-in function normalizedAffineGapDistance&gt;, 1, 2), (&#39;middle_name&#39;, &lt;built-in function normalizedAffineGapDistance&gt;, 2, 3), (&#39;dob_year&#39;, &lt;built-in function normalizedAffineGapDistance&gt;, 3, 4), (&#39;dob_month&#39;, &lt;built-in function normalizedAffineGapDistance&gt;, 4, 5)]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And the input values for this particular pair of records by:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">deduper</span><span class="o">.</span><span class="n">data_model</span><span class="o">.</span><span class="n">distances</span><span class="p">(</span><span class="n">record_pairs</span><span class="o">=</span><span class="n">record_pairs</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[[ 0.5         4.69999981  4.79166651  1.75        5.5       ]]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The coefficients in the model itself are given by:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">deduper</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[-11.37927761  -7.32188256  -0.63712457 -14.30634516  -4.50698292]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Anyway, after training we can save the data we labelled, as well as the settings for this particular run:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">settings_file</span> <span class="o">=</span> <span class="s1">&#39;dedupe_settings&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">deduper</span><span class="o">.</span><span class="n">writeSettings</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">training_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">deduper</span><span class="o">.</span><span class="n">writeTraining</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The training finds both the Predicates for creating 'blocks' (or 'canopies' - for a good explanation, see <a href="http://www.kamalnigam.com/papers/canopy-kdd00.pdf">this</a> excellent paper) and the classifier for actually determining whether two records are referring to the same entity.</p>
<p>The <a href="http://dedupe.readthedocs.io/en/latest/Making-smart-comparisons.html">documentation</a> provides a good overview on why one might want to use blocks/canopies.</p>
<p>My understanding is that blocks/canopies are created for every single predicate - in other words, blocks/canopies are created on the entire dataset as many times as there are predicates.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">deduper</span><span class="o">.</span><span class="n">blocker</span><span class="o">.</span><span class="n">predicates</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[25]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>((SimplePredicate: (commonThreeTokens, family_name),
  TfidfTextCanopyPredicate: (0.2, middle_name)),
 (SimplePredicate: (commonSixGram, family_name),
  SimplePredicate: (commonThreeTokens, middle_name)),
 (SimplePredicate: (commonTwoTokens, family_name),
  SimplePredicate: (twoGramFingerprint, family_name)),
 (TfidfTextCanopyPredicate: (0.4, family_name),
  TfidfTextCanopyPredicate: (0.8, middle_name)),
 (SimplePredicate: (fingerprint, family_name),
  TfidfNGramCanopyPredicate: (0.4, dob_month)))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some predicates rely on an 'inverted index', these are the <code>CanopyPredicates</code> and the <code>SearchPredicates</code>. You can avoid predicates that rely on inverted indexes by setting <code>index_predicates</code> to <code>False</code> in the <code>train</code> method.</p>
<p>Inverted indexes are used to "find the documents where the word X occurs". Unfortunately it seems quite challenging to print out the inverted index itself to understand exactly what it's doing. Nevermind!</p>
<p>Note that canopies are used by predicates that require an inverted index, and blocks are used by simple predicates. The same row can appear in multiple canopies (i.e. canopies can overlap), while the same row only ever appears in one block.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">deduper</span><span class="o">.</span><span class="n">blocker</span><span class="o">.</span><span class="n">index_fields</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>dob_month
middle_name
family_name
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With large data sets, the data_sample, training_pairs, training_data, and activeLearner objects are potentially very large memory-wise. This command deletes them to free up said memory.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">deduper</span><span class="o">.</span><span class="n">cleanupTraining</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Storing-the-raw-data-in-a-database">Storing the raw data in a database<a class="anchor-link" href="#Storing-the-raw-data-in-a-database">&#182;</a></h2><p>For portability, it's convenient to use SQLite, rather than anything bigger and grander requiring a database server. You probably wouldn't want to deal with hundreds of millions or rows like this though!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[29]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">database_name</span> <span class="o">=</span> <span class="s1">&#39;controlling_entities_dedupe_database.db&#39;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">database_name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;database &#39;{}&#39; already exists. deleting it and starting from scratch!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_name</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>database &#39;controlling_entities_dedupe_database.db&#39; already exists. deleting it and starting from scratch!
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a reminder, the raw, un-deduplicated data looks like this:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[30]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">to_dedupe</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[30]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>family_name</th>
      <th>given_name</th>
      <th>middle_name</th>
      <th>dob_year</th>
      <th>dob_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>White</td>
      <td>Mary</td>
      <td>Jane Ursula</td>
      <td>1961</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>White</td>
      <td>Andrew</td>
      <td>Gwynne Haydon</td>
      <td>1960</td>
      <td>2</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Cooke</td>
      <td>Bernard</td>
      <td>Patrick</td>
      <td>1939</td>
      <td>3</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Schofield</td>
      <td>Peter</td>
      <td>Malcolm</td>
      <td>1944</td>
      <td>2</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Howells</td>
      <td>Peter</td>
      <td>John</td>
      <td>1951</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It's convenient to use pandas to create a table in the database. We store the raw data in a table called <code>actual_data</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[31]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c1</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">c1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS actual_data&quot;</span><span class="p">)</span>
<span class="n">to_dedupe</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;actual_data&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">index_label</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
<span class="n">c1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-inverted-indexes-for-the-fields-that-require-it">Creating inverted indexes for the fields that require it<a class="anchor-link" href="#Creating-inverted-indexes-for-the-fields-that-require-it">&#182;</a></h2><p>i.e. those which have a CanopyPredicate or SearchPredicate associated with them</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[32]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># A dictionary of the Index Predicates that will used for blocking. </span>
<span class="c1"># The keys are the fields the predicates will operate on.</span>
<span class="n">deduper</span><span class="o">.</span><span class="n">blocker</span><span class="o">.</span><span class="n">index_fields</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[32]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>defaultdict(&lt;function dedupe.blocking.Blocker.__init__.&lt;locals&gt;.&lt;lambda&gt;&gt;,
            {&#39;dob_month&#39;: defaultdict(list,
                         {&#39;TfidfNGramCanopyPredicate&#39;: [TfidfNGramCanopyPredicate: (0.4, dob_month)]}),
             &#39;family_name&#39;: defaultdict(list,
                         {&#39;TfidfTextCanopyPredicate&#39;: [TfidfTextCanopyPredicate: (0.4, family_name)]}),
             &#39;middle_name&#39;: defaultdict(list,
                         {&#39;TfidfTextCanopyPredicate&#39;: [TfidfTextCanopyPredicate: (0.2, middle_name),
                           TfidfTextCanopyPredicate: (0.8, middle_name)]})})</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[33]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># this does not add an index if there are no canopy predicates in the index_fields</span>
<span class="n">c3</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">deduper</span><span class="o">.</span><span class="n">blocker</span><span class="o">.</span><span class="n">index_fields</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;creating inverted index on: &#39;</span> <span class="o">+</span> <span class="n">field</span><span class="p">)</span>
    <span class="n">c3</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT DISTINCT {field} FROM actual_data &quot;</span>
               <span class="s2">&quot;WHERE {field} IS NOT NULL&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">))</span>
    <span class="n">field_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c3</span><span class="p">)</span>
    <span class="c1"># Indexes the data from a field for use in an index predicate/canopy</span>
    <span class="c1"># This goes through row-by-row</span>
    <span class="n">deduper</span><span class="o">.</span><span class="n">blocker</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">field_data</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

<span class="n">c3</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>creating inverted index on: dob_month
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:dedupe.blocking:Canopy: TfidfNGramCanopyPredicate: (0.4, dob_month)
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>creating inverted index on: middle_name
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.2, middle_name)
INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.8, middle_name)
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>creating inverted index on: family_name
</pre>
</div>
</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:dedupe.blocking:Canopy: TfidfTextCanopyPredicate: (0.4, family_name)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-the-blocks/canopies">Creating the blocks/canopies<a class="anchor-link" href="#Creating-the-blocks/canopies">&#182;</a></h2><p>Start by creating the (empty) table in the database that will contain the mapping between the blocks and the row_ids.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[34]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c2</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS blocking_map&quot;</span><span class="p">)</span>
<span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE blocking_map &quot;</span>
          <span class="s2">&quot;(block_key VARCHAR(200), id INTEGER) &quot;</span><span class="p">)</span>
<span class="n">c2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[35]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">SELECT_STATEMENT</span> <span class="o">=</span> <span class="s2">&quot;SELECT id, family_name, given_name, middle_name, &quot;</span> \
                   <span class="s2">&quot;dob_year, dob_month FROM actual_data&quot;</span>

<span class="n">c4</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;writing blocking map&#39;</span><span class="p">)</span>
<span class="n">c4</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SELECT_STATEMENT</span><span class="p">)</span>
<span class="c1"># the data should be fed to the blocker as an iterable of the form:</span>
<span class="c1"># data = [(1, {&#39;name&#39; : &#39;bob&#39;}), (2, {&#39;name&#39; : &#39;suzanne&#39;}), ... ]</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="s1">&#39;family_name&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="s1">&#39;given_name&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                       <span class="s1">&#39;middle_name&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                       <span class="s1">&#39;dob_year&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                       <span class="s1">&#39;dob_month&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]})</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c4</span><span class="p">)</span>
<span class="c1"># Generate the predicates for records. Yields tuples of (predicate, record_id)</span>
<span class="n">b_data</span> <span class="o">=</span> <span class="n">deduper</span><span class="o">.</span><span class="n">blocker</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span>
<span class="c1"># b_data has the form:</span>
<span class="c1"># [(&#39;foo:1&#39;, 1), ..., (&#39;bar:1&#39;, 100)]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>writing blocking map
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[36]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># b_data is a generator so will yield output as looped over</span>
<span class="n">c5</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">b_data</span><span class="p">:</span>
    <span class="n">c5</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO blocking_map (block_key, id) VALUES (&#39;{block_key}&#39;,{id})&quot;</span><span class="o">.</span>\
               <span class="n">format</span><span class="p">(</span><span class="n">block_key</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">c5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">c4</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:dedupe.blocking:10000, 0.8866982 seconds
INFO:dedupe.blocking:20000, 1.6555902 seconds
INFO:dedupe.blocking:30000, 2.4064102 seconds
INFO:dedupe.blocking:40000, 3.1403292 seconds
INFO:dedupe.blocking:50000, 3.8846132 seconds
INFO:dedupe.blocking:60000, 4.6088152 seconds
INFO:dedupe.blocking:70000, 5.3391912 seconds
INFO:dedupe.blocking:80000, 6.0645912 seconds
INFO:dedupe.blocking:90000, 6.7555952 seconds
INFO:dedupe.blocking:100000, 7.4369202 seconds
INFO:dedupe.blocking:110000, 8.1320572 seconds
INFO:dedupe.blocking:120000, 8.8197112 seconds
INFO:dedupe.blocking:130000, 9.5520212 seconds
INFO:dedupe.blocking:140000, 10.3426402 seconds
INFO:dedupe.blocking:150000, 11.1764612 seconds
INFO:dedupe.blocking:160000, 12.0623922 seconds
INFO:dedupe.blocking:170000, 12.9916722 seconds
INFO:dedupe.blocking:180000, 13.9297212 seconds
INFO:dedupe.blocking:190000, 14.8699092 seconds
INFO:dedupe.blocking:200000, 15.7996292 seconds
INFO:dedupe.blocking:210000, 16.5510012 seconds
INFO:dedupe.blocking:220000, 17.2484762 seconds
INFO:dedupe.blocking:230000, 17.9182622 seconds
INFO:dedupe.blocking:240000, 18.6009632 seconds
INFO:dedupe.blocking:250000, 19.2736792 seconds
INFO:dedupe.blocking:260000, 19.9467552 seconds
INFO:dedupe.blocking:270000, 20.6309332 seconds
INFO:dedupe.blocking:280000, 21.2957982 seconds
INFO:dedupe.blocking:290000, 21.9544192 seconds
INFO:dedupe.blocking:300000, 22.6275562 seconds
INFO:dedupe.blocking:310000, 23.4300932 seconds
INFO:dedupe.blocking:320000, 24.1403062 seconds
INFO:dedupe.blocking:330000, 24.8197872 seconds
INFO:dedupe.blocking:340000, 25.4823882 seconds
INFO:dedupe.blocking:350000, 26.1421512 seconds
INFO:dedupe.blocking:360000, 26.8031332 seconds
INFO:dedupe.blocking:370000, 27.4551432 seconds
INFO:dedupe.blocking:380000, 28.1198822 seconds
INFO:dedupe.blocking:390000, 28.7666722 seconds
INFO:dedupe.blocking:400000, 29.4340742 seconds
INFO:dedupe.blocking:410000, 30.0859422 seconds
INFO:dedupe.blocking:420000, 30.7262992 seconds
INFO:dedupe.blocking:430000, 31.3874802 seconds
INFO:dedupe.blocking:440000, 32.0366312 seconds
INFO:dedupe.blocking:450000, 32.7143132 seconds
INFO:dedupe.blocking:460000, 33.3956372 seconds
INFO:dedupe.blocking:470000, 34.1253152 seconds
INFO:dedupe.blocking:480000, 34.8132422 seconds
INFO:dedupe.blocking:490000, 35.4847342 seconds
INFO:dedupe.blocking:500000, 36.1423512 seconds
INFO:dedupe.blocking:510000, 36.7974212 seconds
INFO:dedupe.blocking:520000, 37.4679592 seconds
INFO:dedupe.blocking:530000, 38.1166822 seconds
INFO:dedupe.blocking:540000, 38.8171572 seconds
INFO:dedupe.blocking:550000, 39.5315302 seconds
INFO:dedupe.blocking:560000, 40.2375672 seconds
INFO:dedupe.blocking:570000, 40.9275792 seconds
INFO:dedupe.blocking:580000, 41.7327812 seconds
INFO:dedupe.blocking:590000, 42.4457382 seconds
INFO:dedupe.blocking:600000, 43.1246422 seconds
INFO:dedupe.blocking:610000, 43.7684642 seconds
INFO:dedupe.blocking:620000, 44.5120412 seconds
INFO:dedupe.blocking:630000, 45.2681682 seconds
INFO:dedupe.blocking:640000, 45.9224352 seconds
INFO:dedupe.blocking:650000, 46.5498092 seconds
INFO:dedupe.blocking:660000, 47.2548972 seconds
INFO:dedupe.blocking:670000, 48.0567672 seconds
INFO:dedupe.blocking:680000, 48.7506512 seconds
INFO:dedupe.blocking:690000, 49.6441622 seconds
INFO:dedupe.blocking:700000, 50.6131992 seconds
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The blocking_map actually looks like the following:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[37]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># How well has the blocking worked? check that there are not loads of blocks with single counts</span>
<span class="n">blocking_map_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM blocking_map&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">blocking_map_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[37]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>block_key</th>
      <th>id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>471:299:3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>471:300:3</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>814:206:3</td>
      <td>7</td>
    </tr>
    <tr>
      <th>3</th>
      <td>217:301:3</td>
      <td>8</td>
    </tr>
    <tr>
      <th>4</th>
      <td>815:131:3</td>
      <td>9</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Conceptually, you can think of the blocks/canopies as looking something like this (note that you end up with this situation for each Predicate dedupe finds):</p>
<p><img src="./diagrams/blocking_map.png" ,width="400,height=400," style="float: left;"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And here is a list of the ten largest blocks:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[38]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">blocking_map_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;block_key&#39;</span><span class="p">)[</span><span class="s1">&#39;block_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[38]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>block_key
Valaitis:3:4    668
Smith:4:4       470
Smith:1:4       459
3591:233:3      448
Smith:3:4       419
Jones:1:4       347
Jones:4:4       346
Jones:3:4       306
75:663:3        297
75:19:3         291
Name: block_key, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note - when rows do not fall into any block they are excluded (because they can only be singletons), so the length of the <code>blocking_map</code> might be shorter than the overall data.</p>
<p>It may, of course, also be longer as the same row can appear in multiple blocks/canopies.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[39]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocking_map_df</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_dedupe</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>570464
706151
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If we merge the blocking map back onto the original data, we can see what has been lumped together:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[40]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">blocking_map_df</span><span class="p">,</span> <span class="n">to_dedupe</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[41]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">merged</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;block_key&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[41]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>block_key</th>
      <th>id</th>
      <th>family_name</th>
      <th>given_name</th>
      <th>middle_name</th>
      <th>dob_year</th>
      <th>dob_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>526870</th>
      <td>02893324178:3:4</td>
      <td>699883</td>
      <td>02893324178</td>
      <td>Derek</td>
      <td>Higgins</td>
      <td>1949</td>
      <td>11</td>
    </tr>
    <tr>
      <th>255126</th>
      <td>08022036:4:4</td>
      <td>320653</td>
      <td>08022036</td>
      <td>Nicola</td>
      <td>None</td>
      <td>1968</td>
      <td>10</td>
    </tr>
    <tr>
      <th>137923</th>
      <td>0Brien:1:4</td>
      <td>171840</td>
      <td>0'Brien</td>
      <td>Ivana</td>
      <td>Maria</td>
      <td>1962</td>
      <td>12</td>
    </tr>
    <tr>
      <th>443993</th>
      <td>100003:36449:3</td>
      <td>572372</td>
      <td>Semerean</td>
      <td>Ovidiu</td>
      <td>Severian</td>
      <td>1976</td>
      <td>11</td>
    </tr>
    <tr>
      <th>274820</th>
      <td>10000:264:3</td>
      <td>346236</td>
      <td>Meachin</td>
      <td>Robert</td>
      <td>James</td>
      <td>1982</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[42]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">family_name</span> <span class="o">==</span> <span class="s1">&#39;Loch&#39;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[42]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>block_key</th>
      <th>id</th>
      <th>family_name</th>
      <th>given_name</th>
      <th>middle_name</th>
      <th>dob_year</th>
      <th>dob_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>187114</th>
      <td>42572:35:3</td>
      <td>233786</td>
      <td>Loch</td>
      <td>Pamela</td>
      <td>Ann</td>
      <td>1967</td>
      <td>1</td>
    </tr>
    <tr>
      <th>373228</th>
      <td>42572:35:3</td>
      <td>477017</td>
      <td>Loch</td>
      <td>Pamela</td>
      <td>Ann</td>
      <td>1967</td>
      <td>1</td>
    </tr>
    <tr>
      <th>512293</th>
      <td>42572:35:3</td>
      <td>677794</td>
      <td>Loch</td>
      <td>Pam</td>
      <td>Ann</td>
      <td>1967</td>
      <td>1</td>
    </tr>
    <tr>
      <th>536487</th>
      <td>42572:18:3</td>
      <td>713316</td>
      <td>Loch</td>
      <td>Elizabeth</td>
      <td>Mary</td>
      <td>1963</td>
      <td>2</td>
    </tr>
    <tr>
      <th>570463</th>
      <td>NaN</td>
      <td>237119</td>
      <td>Loch</td>
      <td>Richard</td>
      <td>None</td>
      <td>1968</td>
      <td>8</td>
    </tr>
    <tr>
      <th>570463</th>
      <td>NaN</td>
      <td>759367</td>
      <td>Loch</td>
      <td>Pam</td>
      <td>None</td>
      <td>1967</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, we create an index on the <code>block_key</code> for faster queries, and free up memory used by the inverted indexes:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[43]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;indexing block_key&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX blocking_map_key_idx ON blocking_map (block_key)&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:indexing block_key
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[43]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[44]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">deduper</span><span class="o">.</span><span class="n">blocker</span><span class="o">.</span><span class="n">resetIndices</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="SQL-manipulations-to-prepare-blocks-for-matching">SQL manipulations to prepare blocks for matching<a class="anchor-link" href="#SQL-manipulations-to-prepare-blocks-for-matching">&#182;</a></h2><p>The next steps require some data manipulations to prepare the blocks into the format required by the <code>matchBlocks</code> method. See the <code>matchBlocks</code> section in the <a href="https://dedupe.readthedocs.io/en/latest/API-documentation.html#dedupe-objects">documentation</a> for exactly what that format is.</p>
<p>A MySQL version of these steps can be found <a href="http://datamade.github.io/dedupe-examples/docs/mysql_example.html#section-26">here</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>These are the tables that we will be created shortly:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[45]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS plural_key&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS plural_block&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS covered_blocks&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS smaller_coverage&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[45]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Plural-Key-table">Plural Key table<a class="anchor-link" href="#Plural-Key-table">&#182;</a></h3><p>Here, the block_keys (which are fairly long varchar types) are reassigned an integer id, imaginatively called block_id. Further, if one block_key forms identical blocks, we only keep one of them. Further further, we only keep blocks that have more than one record in them (as that record is obviously not going to be matched to another record) - this is why the word 'plural' is used!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[46]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;calculating plural_key&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot; DROP TABLE IF EXISTS plural_key&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE plural_key &quot;</span>
          <span class="s2">&quot;(block_key VARCHAR(200), &quot;</span>
          <span class="s2">&quot; block_id INTEGER PRIMARY KEY AUTOINCREMENT)  &quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:calculating plural_key
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[46]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[47]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot; INSERT INTO plural_key (block_key) &quot;</span>
          <span class="s2">&quot; SELECT MIN(block_key) FROM &quot;</span>
          <span class="s2">&quot;    (SELECT block_key, GROUP_CONCAT(id) AS block FROM &quot;</span>
          <span class="s2">&quot;       (SELECT block_key, id FROM blocking_map ORDER BY block_key, id) AS a &quot;</span>
          <span class="s2">&quot;    GROUP BY block_key &quot;</span>
          <span class="s2">&quot;    HAVING COUNT(*) &gt; 1) AS b &quot;</span>
          <span class="s2">&quot; GROUP BY block  &quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[47]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>... and this is what <code>plural_key</code> actually looks like:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[48]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">plural_key_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM plural_key&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">plural_key_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[48]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>block_key</th>
      <th>block_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>471:299:3</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>471:300:3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Osborne:4:4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Folan:1:4</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Folan:3:4</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The length of <code>plural_key</code> is the number of blocks within which records will be matched later:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[49]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plural_key_df</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>66318
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a sanity check, there should be no duplicated rows in <code>plural_key</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[50]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plural_key_df</span><span class="p">[</span><span class="n">plural_key_df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;no duplicated rows in plural_key&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;somehow duplicated rows have crept into plural_key - fix before continuing!!&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>no duplicated rows in plural_key
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And finally we index the table appropriately:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[51]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating block_key index&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE UNIQUE INDEX block_key_idx ON plural_key (block_key)&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:creating block_key index
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[51]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Plural-Block-table">Plural Block table<a class="anchor-link" href="#Plural-Block-table">&#182;</a></h3><p>This simply links <code>block_id</code> calculated in <code>plural_key</code> above back to the records that each block contains (as represented by <code>id</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[52]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;calculating plural_block&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot; DROP TABLE IF EXISTS plural_block &quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot; CREATE TABLE plural_block AS &quot;</span>
          <span class="s2">&quot; SELECT block_id, id &quot;</span>
          <span class="s2">&quot; FROM blocking_map AS a &quot;</span>
          <span class="s2">&quot; INNER JOIN plural_key AS b &quot;</span>
          <span class="s2">&quot; ON a.block_key = b.block_key &quot;</span>
          <span class="s2">&quot; ORDER BY block_id, id&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:calculating plural_block
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[52]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[53]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">plural_block_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM plural_block&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">plural_block_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[53]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>block_id</th>
      <th>id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>605691</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>605692</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>1000</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[54]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plural_block_df</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>294466
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[55]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plural_block_df</span><span class="p">[</span><span class="n">plural_block_df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;no duplicated rows in plural_block&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;somehow duplicated rows have crept into plural_block - fix before continuing!!&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>no duplicated rows in plural_block
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[56]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding id index and sorting index&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX plural_block_id_idx ON plural_block (id)&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE UNIQUE INDEX plural_block_block_id_id_uniq &quot;</span>
          <span class="s2">&quot; ON plural_block (block_id, id)&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:adding id index and sorting index
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[56]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Covered-Blocks-table">Covered Blocks table<a class="anchor-link" href="#Covered-Blocks-table">&#182;</a></h3><p>This table maps records to the blocks they appear in (if more than one, all blocks are concatenated with a comma separator). Remember that, at this stage, blocks with just one record in ("singleton" blocks) have been excluded.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[57]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating covered_blocks&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot; CREATE TABLE covered_blocks AS &quot;</span>
          <span class="s2">&quot; SELECT id, GROUP_CONCAT(block_id) AS sorted_ids&quot;</span>
          <span class="s2">&quot; FROM (SELECT id, block_id FROM plural_block ORDER BY id, block_id) AS a &quot;</span>
          <span class="s2">&quot; GROUP BY id&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:creating covered_blocks
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[57]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[58]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">covered_blocks_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM covered_blocks&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">covered_blocks_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[58]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>sorted_ids</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>7</td>
      <td>57783</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9</td>
      <td>64129</td>
    </tr>
    <tr>
      <th>4</th>
      <td>13</td>
      <td>6112</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Number of rows in <code>covered_blocks</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[59]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">covered_blocks_df</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>258376
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Examples of rows which appear in more than one block:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[60]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">covered_blocks_df</span><span class="p">[</span><span class="n">covered_blocks_df</span><span class="o">.</span><span class="n">sorted_ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[60]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>sorted_ids</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>9</th>
      <td>27</td>
      <td>27254,27255</td>
    </tr>
    <tr>
      <th>19</th>
      <td>75</td>
      <td>60564,60565</td>
    </tr>
    <tr>
      <th>20</th>
      <td>80</td>
      <td>61869,61870</td>
    </tr>
    <tr>
      <th>24</th>
      <td>92</td>
      <td>64591,64592</td>
    </tr>
    <tr>
      <th>41</th>
      <td>197</td>
      <td>17381,17382</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[61]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE UNIQUE INDEX covered_blocks_id_idx &quot;</span>
          <span class="s2">&quot;ON covered_blocks (id)&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[61]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[62]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Smaller-Coverage-table">Smaller Coverage table<a class="anchor-link" href="#Smaller-Coverage-table">&#182;</a></h3><p>This table is a PITA to think about. Essentially, it says: for each record, which <code>block_id</code> is it in; is it in any other <code>block_ids</code>; and if so, which other <code>block_ids</code> are smaller than this one? The purpose is that we don't want to make multiple comparisons of the same pairs of records. If both records fall into the two blocks, for example, we only want to compare them once.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[63]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating smaller_coverage&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot; DROP TABLE IF EXISTS smaller_coverage &quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot; CREATE TABLE smaller_coverage &quot;</span>
          <span class="s2">&quot; AS SELECT a.id, block_id, sorted_ids, &quot;</span>
          <span class="s2">&quot;           RTRIM(SUBSTR(sorted_ids, 1, INSTR(sorted_ids, block_id) - 1), &#39;,&#39;) as smaller_ids &quot;</span>
          <span class="s2">&quot; FROM plural_block AS a &quot;</span>
          <span class="s2">&quot; INNER JOIN covered_blocks AS b &quot;</span>
          <span class="s2">&quot; ON a.id = b.id&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:creating smaller_coverage
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[63]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[64]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">smaller_coverage_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM smaller_coverage&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">smaller_coverage_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[64]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>block_id</th>
      <th>sorted_ids</th>
      <th>smaller_ids</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>605691</td>
      <td>1</td>
      <td>1</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>605692</td>
      <td>2</td>
      <td>2</td>
      <td></td>
    </tr>
    <tr>
      <th>4</th>
      <td>1000</td>
      <td>3</td>
      <td>3</td>
      <td></td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[65]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smaller_coverage_df</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>294466
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Examples of where <code>smaller_ids</code> is not empty:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[66]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">smaller_coverage_df</span><span class="p">[</span><span class="n">smaller_coverage_df</span><span class="o">.</span><span class="n">smaller_ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[66]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>block_id</th>
      <th>sorted_ids</th>
      <th>smaller_ids</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>69828</th>
      <td>178568</td>
      <td>14600</td>
      <td>14598,14599,14600</td>
      <td>14598,14599</td>
    </tr>
    <tr>
      <th>69829</th>
      <td>223486</td>
      <td>14600</td>
      <td>14598,14599,14600</td>
      <td>14598,14599</td>
    </tr>
    <tr>
      <th>69830</th>
      <td>245362</td>
      <td>14600</td>
      <td>14598,14599,14600</td>
      <td>14598,14599</td>
    </tr>
    <tr>
      <th>69936</th>
      <td>178720</td>
      <td>14628</td>
      <td>7265,14627,14628</td>
      <td>7265,14627</td>
    </tr>
    <tr>
      <th>69937</th>
      <td>241185</td>
      <td>14628</td>
      <td>7265,14627,14628</td>
      <td>7265,14627</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Clustering-within-the-blocks/canopies">Clustering within the blocks/canopies<a class="anchor-link" href="#Clustering-within-the-blocks/canopies">&#182;</a></h2><p>First create the final table that is fed to <code>matchBlocks</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[67]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating final table&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE final AS &quot;</span>
          <span class="s2">&quot;SELECT a.id, family_name,given_name, middle_name, dob_year, dob_month, &quot;</span>
          <span class="s2">&quot;block_id, smaller_ids &quot;</span>
          <span class="s2">&quot;FROM smaller_coverage AS a &quot;</span>
          <span class="s2">&quot;INNER JOIN actual_data AS b &quot;</span>
          <span class="s2">&quot;ON a.id = b.id &quot;</span>
          <span class="s2">&quot;ORDER BY (block_id)&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:creating final table
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[67]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[68]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[69]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">to_match</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM final&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">to_match</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[69]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>family_name</th>
      <th>given_name</th>
      <th>middle_name</th>
      <th>dob_year</th>
      <th>dob_month</th>
      <th>block_id</th>
      <th>smaller_ids</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>White</td>
      <td>Mary</td>
      <td>Jane Ursula</td>
      <td>1961</td>
      <td>8</td>
      <td>1</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>605691</td>
      <td>White</td>
      <td>Mary</td>
      <td>Jane Ursula</td>
      <td>1961</td>
      <td>8</td>
      <td>1</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>White</td>
      <td>Andrew</td>
      <td>Gwynne Haydon</td>
      <td>1960</td>
      <td>2</td>
      <td>2</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>605692</td>
      <td>White</td>
      <td>Andrew</td>
      <td>Gwynne Haydon</td>
      <td>1960</td>
      <td>2</td>
      <td>2</td>
      <td></td>
    </tr>
    <tr>
      <th>4</th>
      <td>1000</td>
      <td>Osborne</td>
      <td>Jill</td>
      <td>Penelope</td>
      <td>1951</td>
      <td>10</td>
      <td>3</td>
      <td></td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Write a generator function that feeds the blocks to <code>matchBlocks</code> in the correct format:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[70]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Clustering function</span>
<span class="k">def</span> <span class="nf">candidates_gen</span><span class="p">(</span><span class="n">result_set</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">lset</span> <span class="o">=</span> <span class="nb">set</span>

    <span class="n">block_id</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result_set</span> <span class="p">:</span>
        <span class="c1"># need to change from list to dict for sqlite query</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="s1">&#39;family_name&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="s1">&#39;given_name&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
               <span class="s1">&#39;middle_name&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
               <span class="s1">&#39;dob_year&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
               <span class="s1">&#39;dob_month&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
               <span class="s1">&#39;block_id&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
               <span class="s1">&#39;smaller_ids&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]}</span>

        <span class="c1"># if there&#39;s a new block id then yield the old block</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;block_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">block_id</span> <span class="p">:</span>
            <span class="c1">#print(&quot;done with block id: {}&quot;.format(row[&#39;block_id&#39;]))</span>
            <span class="k">if</span> <span class="n">records</span> <span class="p">:</span>
                <span class="c1">#print(len(records))</span>
                <span class="k">yield</span> <span class="n">records</span>

            
            <span class="n">block_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;block_id&#39;</span><span class="p">]</span>
            <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;blocks&quot;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="s2">&quot;seconds&quot;</span><span class="p">)</span>

        <span class="n">smaller_ids</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;smaller_ids&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">smaller_ids</span> <span class="p">:</span>
            <span class="n">smaller_ids</span> <span class="o">=</span> <span class="n">lset</span><span class="p">(</span><span class="n">smaller_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">smaller_ids</span> <span class="o">=</span> <span class="n">lset</span><span class="p">([])</span>

        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">,</span> <span class="n">smaller_ids</span><span class="p">))</span>

    <span class="c1"># once gone through the loop need to yield the last block</span>
    <span class="k">if</span> <span class="n">records</span> <span class="p">:</span>
        <span class="k">yield</span> <span class="n">records</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Deal with the bug where <code>matchBlocks</code> hangs if it is using more than one core:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[71]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># this has to be set to 1 or matchBlocks fails</span>
<span class="n">deduper</span><span class="o">.</span><span class="n">num_cores</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[72]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM final&quot;</span><span class="p">)</span>
<span class="c1"># cands is the iterable</span>
<span class="n">cands</span> <span class="o">=</span> <span class="n">candidates_gen</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>clustering...
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally - at the stage where we can perform the comparison between all the records in a block:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[73]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;clustering...&#39;</span><span class="p">)</span>
<span class="n">clustered_dupes</span> <span class="o">=</span> <span class="n">deduper</span><span class="o">.</span><span class="n">matchBlocks</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>10000 blocks
11.290481805801392 seconds
20000 blocks
15.696646928787231 seconds
30000 blocks
20.057891845703125 seconds
40000 blocks
23.997675895690918 seconds
50000 blocks
28.32711100578308 seconds
60000 blocks
32.93247079849243 seconds
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Saving-the-results">Saving the results<a class="anchor-link" href="#Saving-the-results">&#182;</a></h2><p>We store the results of <code>matchBlocks</code> in a table called <code>entity_map</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[74]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS entity_map&quot;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;creating entity_map database&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE entity_map &quot;</span>
          <span class="s2">&quot;(id INTEGER, canon_id INTEGER, &quot;</span>
          <span class="s2">&quot; cluster_score FLOAT, PRIMARY KEY(id))&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>creating entity_map database
</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">Out[74]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;sqlite3.Cursor at 0x1358b8500&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[75]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">clustered_dupes</span> <span class="p">:</span>
    <span class="n">cluster_id</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;INSERT INTO entity_map VALUES ({}, {}, {})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cluster_id</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[76]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX head_index ON entity_map (canon_id)&quot;</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[77]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">entity_map_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM entity_map&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[78]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">entity_map_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[78]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>canon_id</th>
      <th>cluster_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>9</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>13</td>
      <td>13</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>24</td>
      <td>24</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Print the number of duplicates found:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[79]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;# duplicate sets&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clustered_dupes</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre># duplicate sets
32805
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Combining-the-results-with-the-original-data">Combining the results with the original data<a class="anchor-link" href="#Combining-the-results-with-the-original-data">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[80]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">to_dedupe</span><span class="p">,</span> <span class="n">entity_map_df</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[81]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">output</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;canon_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[81]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>family_name</th>
      <th>given_name</th>
      <th>middle_name</th>
      <th>dob_year</th>
      <th>dob_month</th>
      <th>id</th>
      <th>canon_id</th>
      <th>cluster_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>White</td>
      <td>Mary</td>
      <td>Jane Ursula</td>
      <td>1961</td>
      <td>8</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>65881</th>
      <td>White</td>
      <td>Mary</td>
      <td>Jane Ursula</td>
      <td>1961</td>
      <td>8</td>
      <td>605691</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>White</td>
      <td>Andrew</td>
      <td>Gwynne Haydon</td>
      <td>1960</td>
      <td>2</td>
      <td>1</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>65882</th>
      <td>White</td>
      <td>Andrew</td>
      <td>Gwynne Haydon</td>
      <td>1960</td>
      <td>2</td>
      <td>605692</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Howells</td>
      <td>Peter</td>
      <td>John</td>
      <td>1951</td>
      <td>3</td>
      <td>9</td>
      <td>9.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4703</th>
      <td>Howells</td>
      <td>Peter</td>
      <td>John</td>
      <td>1951</td>
      <td>3</td>
      <td>33099</td>
      <td>9.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>120</th>
      <td>Sanderson</td>
      <td>John</td>
      <td>Francis</td>
      <td>1941</td>
      <td>9</td>
      <td>895</td>
      <td>13.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>21394</th>
      <td>Sanderson</td>
      <td>John</td>
      <td>Francis</td>
      <td>1941</td>
      <td>9</td>
      <td>173796</td>
      <td>13.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Sanderson</td>
      <td>John</td>
      <td>Francis</td>
      <td>1941</td>
      <td>9</td>
      <td>13</td>
      <td>13.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Richardson</td>
      <td>Eric</td>
      <td>Keith</td>
      <td>1939</td>
      <td>1</td>
      <td>24</td>
      <td>24.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>An example of success - for this person, the <code>dob_year</code> is different, but each row fairly surely refers to the same thing, so they have the same <code>canon_id</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[86]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">family_name</span> <span class="o">==</span> <span class="s1">&#39;Meath Baker&#39;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[86]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>family_name</th>
      <th>given_name</th>
      <th>middle_name</th>
      <th>dob_year</th>
      <th>dob_month</th>
      <th>id</th>
      <th>canon_id</th>
      <th>cluster_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>46</th>
      <td>Meath Baker</td>
      <td>Prescilla</td>
      <td>Ann</td>
      <td>1937</td>
      <td>5</td>
      <td>361</td>
      <td>361.0</td>
      <td>0.764748</td>
    </tr>
    <tr>
      <th>81</th>
      <td>Meath Baker</td>
      <td>Prescilla</td>
      <td>Ann</td>
      <td>1938</td>
      <td>5</td>
      <td>610</td>
      <td>361.0</td>
      <td>0.764748</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Rows with the same <code>canon_id</code> are the rows which dedupe believes are the referring to the same thing. The <code>cluster_score</code> is a measure of how sure dedupe is about the comparison. If there is no <code>canon_id</code> at all, dedupe doesn't believe that that row has a pair.</p>
<p>By playing with the precision/recall in the <code>train</code> (and other?) methods, one can move the metaphorical slider between capturing <em>all</em> of the duplicated records (at the expense of including some pairs which aren't referring to the same person - high recall), and being certain that the records you say are pairs really are pairs (at the expense of missing some of the pairs that should be lumped together - high precision).</p>
<p>Much more information about entity resolution can be found in this <a href="http://www.cs.utexas.edu/~ml/papers/marlin-dissertation-06.pdf">PhD thesis</a>. Indeed the dedupe package itself is based on this work!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[87]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># save output to a csv</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;entity_resolved_controlling_entities.csv&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/handy_functions.html" rel="bookmark"
                           title="Permalink to Handy Functions">Handy Functions</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-10-24T09:30:00+01:00">
                Published: Mon 24 October 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/ned.html">Ned</a>
        </address>
<p>In <a href="/category/data-science.html">Data Science</a>.</p>
<p>tags: <a href="/tag/data-science.html">data science</a> <a href="/tag/python.html">python</a> <a href="/tag/handy-function.html">handy function</a> </p>
</footer><!-- /.post-info -->                
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
                <a class="readmore" href="/handy_functions.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/fitting_all_of_scipys_distributions.html" rel="bookmark"
                           title="Permalink to Fitting All of Scipy's Distributions">Fitting All of Scipy's Distributions</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-10-15T16:25:00+01:00">
                Published: Sat 15 October 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/ned.html">Ned</a>
        </address>
<p>In <a href="/category/data-science.html">Data Science</a>.</p>
<p>tags: <a href="/tag/data-science.html">data science</a> <a href="/tag/tutorial.html">tutorial</a> <a href="/tag/interview.html">interview</a> <a href="/tag/handy-function.html">handy function</a> </p>
</footer><!-- /.post-info -->                
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
                <a class="readmore" href="/fitting_all_of_scipys_distributions.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/model_flexibility_and_the_risk_of_overfitting.html" rel="bookmark"
                           title="Permalink to Model Flexibility and the Risk of Overfitting">Model Flexibility and the Risk of Overfitting</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-10-10T13:50:00+01:00">
                Published: Mon 10 October 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/ned.html">Ned</a>
        </address>
<p>In <a href="/category/data-science.html">Data Science</a>.</p>
<p>tags: <a href="/tag/data-science.html">data science</a> <a href="/tag/tutorial.html">tutorial</a> </p>
</footer><!-- /.post-info -->                
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">Introduction<a class="anchor-link" href="#Introduction">&#182;</a></h2><p>When using a regression model, you've got to be <em>super</em> careful that you aren't overfitting your data. But what does that even mean? What causes an "overfitted" model?</p>
<p>Well, the answer to that question is excessive model flexibility. But again, "excessive flexibility" is not the most understandable of responses. Hopefully this post will shed a bit of light on the matter!</p>
                <a class="readmore" href="/model_flexibility_and_the_risk_of_overfitting.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>